{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///E:/test_python/vat-ly-11-lab/test/app/api/chat/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\nconst API_KEY = process.env.GEMINI_API_KEY;\r\n\r\nexport async function POST(req: Request) {\r\n    try {\r\n        const { message, history, experimentId, context } = await req.json();\r\n\r\n        if (!API_KEY) {\r\n            return NextResponse.json({ error: 'API Key not configured' }, { status: 500 });\r\n        }\r\n\r\n        // Specific System Prompts for each Experiment\r\n        const PROMPTS: Record<string, string> = {\r\n            \"spring-oscillator\": `Bạn là \"SpringBot\", trợ lý ảo chuyên về thí nghiệm Con Lắc Lò Xo.\r\nNhiệm vụ: Giải thích về định luật Hooke, chu kỳ dao động T = 2π√(m/k), cơ năng và động năng của lò xo.\r\nPhong cách: Chính xác, khoa học nhưng dễ hiểu. Luôn nhắc nhở học sinh về đơn vị đo (kg, N/m).\r\nChỉ trả lời câu hỏi liên quan đến con lắc lò xo.`,\r\n\r\n            \"simple-pendulum\": `Bạn là \"PendulumBot\", chuyên gia về Con Lắc Đơn.\r\nNhiệm vụ: Hướng dẫn về công thức T = 2π√(l/g), ảnh hưởng của chiều dài dây và gia tốc trọng trường.\r\nLưu ý: Nhắc nhở về điều kiện dao động nhỏ (góc alpha < 10 độ).\r\nChỉ tập trung vào con lắc đơn.`,\r\n\r\n            \"sound-speed\": `Bạn là \"SonicBot\", trợ lý thí nghiệm Đo Tốc Độ Âm Thanh.\r\nNhiệm vụ: Giải thích hiện tượng cộng hưởng trong cột khí.\r\nCông thức quan trọng: Điều kiện cộng hưởng L = (2k+1)λ/4. Tốc độ âm v = λf.\r\nHướng dẫn học sinh cách tìm các vị trí nghe to nhất để đo bước sóng.`,\r\n\r\n            \"mechanical-waves\": `Bạn là \"WaveBot\", chuyên về Sóng Cơ.\r\nNhiệm vụ: Phân biệt sóng ngang và sóng dọc, giải thích phương trình sóng, bước sóng, tần số và tốc độ truyền sóng.`,\r\n\r\n            \"standing-waves\": `Bạn là \"ResonanceBot\", chuyên về Sóng Dừng trên dây.\r\nNhiệm vụ: Giải thích về nút sóng, bụng sóng, điều kiện xảy ra sóng dừng (L = kλ/2 hoặc L = (2k+1)λ/4).`,\r\n\r\n            \"default\": `Bạn là trợ lý ảo phòng thí nghiệm Vật lý cho bài \"${context}\". Hãy giúp học sinh giải đáp thắc mắc liên quan đến bài này.`\r\n        };\r\n\r\n        // Select Prompt\r\n        const specificPrompt = PROMPTS[experimentId] || PROMPTS[\"default\"];\r\n\r\n        const systemPrompt = `${specificPrompt}\r\nQuy tắc chung:\r\n1. Trả lời ngắn gọn, súc tích bằng tiếng Việt.\r\n2. Nếu câu hỏi không liên quan đến bài thí nghiệm hiện tại, hãy lịch sự từ chối và hướng dẫn học sinh quay lại bài học.\r\n3. Khuyến khích học sinh tự thao tác trên mô phỏng.`;\r\n\r\n        // Construct content for Gemini\r\n        const contents = [\r\n            {\r\n                role: \"user\",\r\n                parts: [{ text: systemPrompt }]\r\n            },\r\n            ...history.map((msg: any) => ({\r\n                role: msg.sender === 'user' ? 'user' : 'model',\r\n                parts: [{ text: msg.text }]\r\n            })),\r\n            {\r\n                role: \"user\",\r\n                parts: [{ text: message }]\r\n            }\r\n        ];\r\n\r\n        // Call Google Gemini API (REST)\r\n        // Model: gemini-1.5-flash (Fast & Efficient)\r\n        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`;\r\n\r\n        const response = await fetch(url, {\r\n            method: 'POST',\r\n            headers: {\r\n                'Content-Type': 'application/json',\r\n            },\r\n            body: JSON.stringify({\r\n                contents: contents,\r\n                generationConfig: {\r\n                    temperature: 0.7,\r\n                    maxOutputTokens: 300,\r\n                }\r\n            })\r\n        });\r\n\r\n        const data = await response.json();\r\n\r\n        if (!response.ok) {\r\n            console.error(\"Gemini API Error:\", data);\r\n            return NextResponse.json({ error: data.error?.message || 'AI Error' }, { status: 500 });\r\n        }\r\n\r\n        const botReply = data.candidates?.[0]?.content?.parts?.[0]?.text || \"Xin lỗi, tôi không thể trả lời lúc này.\";\r\n\r\n        return NextResponse.json({ reply: botReply });\r\n\r\n    } catch (error) {\r\n        console.error(\"Server Error:\", error);\r\n        return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });\r\n    }\r\n}\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,UAAU,QAAQ,GAAG,CAAC,cAAc;AAEnC,eAAe,KAAK,GAAY;IACnC,IAAI;QACA,MAAM,EAAE,OAAO,EAAE,OAAO,EAAE,YAAY,EAAE,OAAO,EAAE,GAAG,MAAM,IAAI,IAAI;QAElE,IAAI,CAAC,SAAS;YACV,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAyB,GAAG;gBAAE,QAAQ;YAAI;QAChF;QAEA,8CAA8C;QAC9C,MAAM,UAAkC;YACpC,qBAAqB,CAAC;;;gDAGc,CAAC;YAErC,mBAAmB,CAAC;;;8BAGF,CAAC;YAEnB,eAAe,CAAC;;;oEAGwC,CAAC;YAEzD,oBAAoB,CAAC;kHACiF,CAAC;YAEvG,kBAAkB,CAAC;sGACuE,CAAC;YAE3F,WAAW,CAAC,kDAAkD,EAAE,QAAQ,6DAA6D,CAAC;QAC1I;QAEA,gBAAgB;QAChB,MAAM,iBAAiB,OAAO,CAAC,aAAa,IAAI,OAAO,CAAC,UAAU;QAElE,MAAM,eAAe,GAAG,eAAe;;;;mDAII,CAAC;QAE5C,+BAA+B;QAC/B,MAAM,WAAW;YACb;gBACI,MAAM;gBACN,OAAO;oBAAC;wBAAE,MAAM;oBAAa;iBAAE;YACnC;eACG,QAAQ,GAAG,CAAC,CAAC,MAAa,CAAC;oBAC1B,MAAM,IAAI,MAAM,KAAK,SAAS,SAAS;oBACvC,OAAO;wBAAC;4BAAE,MAAM,IAAI,IAAI;wBAAC;qBAAE;gBAC/B,CAAC;YACD;gBACI,MAAM;gBACN,OAAO;oBAAC;wBAAE,MAAM;oBAAQ;iBAAE;YAC9B;SACH;QAED,gCAAgC;QAChC,6CAA6C;QAC7C,MAAM,MAAM,CAAC,6FAA6F,EAAE,SAAS;QAErH,MAAM,WAAW,MAAM,MAAM,KAAK;YAC9B,QAAQ;YACR,SAAS;gBACL,gBAAgB;YACpB;YACA,MAAM,KAAK,SAAS,CAAC;gBACjB,UAAU;gBACV,kBAAkB;oBACd,aAAa;oBACb,iBAAiB;gBACrB;YACJ;QACJ;QAEA,MAAM,OAAO,MAAM,SAAS,IAAI;QAEhC,IAAI,CAAC,SAAS,EAAE,EAAE;YACd,QAAQ,KAAK,CAAC,qBAAqB;YACnC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO,KAAK,KAAK,EAAE,WAAW;YAAW,GAAG;gBAAE,QAAQ;YAAI;QACzF;QAEA,MAAM,WAAW,KAAK,UAAU,EAAE,CAAC,EAAE,EAAE,SAAS,OAAO,CAAC,EAAE,EAAE,QAAQ;QAEpE,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAS;IAE/C,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,iBAAiB;QAC/B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC/E;AACJ"}}]
}