<!DOCTYPE html>
<html>
<head>
    <title>test</title>
    <meta charset="utf-8">
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>body { background-color: #0f172a; color: white; margin: 0; min-height: 100vh; }</style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        import React, { useState, useEffect, useRef } from 'react';
import { Play, Pause, SkipForward, SkipBack, Activity, Settings, Maximize, Minimize, MousePointer2, Waves, Mic, GitCommit, Sliders, Info, Eye, EyeOff, RotateCcw } from 'lucide-react';

// --- CẤU HÌNH HẰNG SỐ & MÀU SẮC NEON ---
const CONSTANTS = {
  g: 9.8,
  pi: Math.PI,
  colors: {
    displacement: '#3b82f6', // Xanh dương (Li độ x)
    velocity: '#10b981',     // Xanh lá (Vận tốc v)
    acceleration: '#ef4444', // Đỏ (Gia tốc a)
    grid: '#1e293b',         // Nền lưới tối
    text: '#f1f5f9',         // Chữ trắng sáng
    marker: '#94a3b8',       // Đường gióng xám
    axis: '#94a3b8',         // Trục xám sáng
    spring: '#cbd5e1',       // Màu lò xo
    mechanical: '#ec4899',   // Tím hồng (Sóng)
  }
};

const ZONES = [
  { id: 0, name: 'Tổng Quan', icon: Info },
  { id: 1, name: 'DĐ Điều Hòa', icon: Activity },
  { id: 2, name: 'Lò Xo', icon: Settings },
  { id: 3, name: 'Con Lắc Đơn', icon: MousePointer2 },
  { id: 4, name: 'Tắt Dần', icon: Minimize },
  { id: 5, name: 'Sóng Cơ', icon: Waves },
  { id: 6, name: 'Sóng Âm', icon: Mic },
  { id: 7, name: 'Giao Thoa', icon: GitCommit },
  { id: 8, name: 'Sóng Dừng', icon: Sliders },
];

// --- HELPER: BACKGROUND GRID ---
const GridBackground = () => (
  <svg className="absolute inset-0 w-full h-full opacity-10 pointer-events-none" xmlns="http://www.w3.org/2000/svg">
    <defs>
      <pattern id="smallGrid" width="20" height="20" patternUnits="userSpaceOnUse">
        <path d="M 20 0 L 0 0 0 20" fill="none" stroke="#475569" strokeWidth="0.5" />
      </pattern>
      <pattern id="grid" width="100" height="100" patternUnits="userSpaceOnUse">
        <rect width="100" height="100" fill="url(#smallGrid)" />
        <path d="M 100 0 L 0 0 0 100" fill="none" stroke="#64748b" strokeWidth="1" />
      </pattern>
    </defs>
    <rect width="100%" height="100%" fill="url(#grid)" />
  </svg>
);

// --- HELPER: HUD (HEADS-UP DISPLAY) ---
const HUD = ({ children, title }) => {
    const [visible, setVisible] = useState(true);
    return (
        <div className={`absolute top-2 right-2 z-30 transition-all duration-300 ${visible ? 'bg-slate-900/90 border border-slate-600' : 'bg-transparent'} rounded shadow-lg p-2`}>
            <div className="flex justify-between items-center gap-4 mb-1">
                {visible && title && <span className="text-[10px] font-bold text-slate-400 uppercase tracking-wider">{title}</span>}
                <button onClick={() => setVisible(!visible)} className="text-slate-400 hover:text-white ml-auto">
                    {visible ? <EyeOff size={14} /> : <Eye size={18} className="bg-slate-800 p-1 rounded-full text-blue-400"/>}
                </button>
            </div>
            {visible && <div className="mt-1">{children}</div>}
        </div>
    );
};

// =================================================================================================
// ZONE 0: TỔNG QUAN
// =================================================================================================
const Zone0Dashboard = () => (
    <div className="flex flex-col items-center justify-center h-full p-8 text-center bg-slate-900/50 overflow-y-auto">
        <h1 className="text-5xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500 mb-6 uppercase tracking-wider filter drop-shadow-lg">
            PHYSLAB PRO 2.0
        </h1>
        <p className="text-slate-400 mb-8 max-w-2xl text-lg">
            Hệ thống mô phỏng Vật lí ảo nâng cao. Trực quan hóa các hiện tượng Dao động, Sóng cơ, Giao thoa và Sóng dừng với độ chính xác cao.
        </p>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl w-full text-left">
            <div className="bg-slate-800/80 p-6 rounded-xl border border-slate-700 hover:border-blue-500 transition-colors shadow-lg">
                <h3 className="text-blue-400 font-bold mb-2 uppercase flex items-center gap-2">
                    <Activity size={18}/> Dao động cơ học
                </h3>
                <p className="text-slate-300 text-sm">
                    Khám phá dao động điều hòa, con lắc lò xo, con lắc đơn và dao động tắt dần trong các môi trường khác nhau.
                </p>
            </div>
            <div className="bg-slate-800/80 p-6 rounded-xl border border-slate-700 hover:border-purple-500 transition-colors shadow-lg">
                <h3 className="text-purple-400 font-bold mb-2 uppercase flex items-center gap-2">
                    <Waves size={18}/> Sóng cơ học
                </h3>
                <p className="text-slate-300 text-sm">
                    Mô phỏng sóng ngang, sóng dọc, hiện tượng giao thoa sóng nước/ánh sáng và sóng dừng trên dây.
                </p>
            </div>
        </div>
    </div>
);

// =================================================================================================
// ZONE 1: DAO ĐỘNG ĐIỀU HÒA (UPDATED: LARGE CIRCLE + COMBINED XVA GRAPH)
// =================================================================================================
const Zone1Harmonic = ({ t, params }) => {
  const { A, f, phi } = params;
  const omega = 2 * Math.PI * f;
  const x = A * Math.cos(omega * t + phi);
  const v = -omega * A * Math.sin(omega * t + phi);
  const a = -omega * omega * x;
  
  // Visual config: Tăng kích thước (scale visual lớn hơn)
  const scale = 25; 
  const cx = 250; // Center X for circle 
  const cy = 250; // Center Y for circle
  const graphWidth = 800; // Chiều rộng đồ thị
  const graphHeight = 250; // Chiều cao đồ thị
  const graphX = 350; // Vị trí X bắt đầu của đồ thị (bên phải vòng tròn)
  const graphY = 120; // Vị trí Y bắt đầu của đồ thị

  // Tỷ lệ chuẩn hóa cho đồ thị (để x, v, a cùng hiển thị)
  const maxA = A * omega * omega;
  const maxV = A * omega;
  const maxVal = Math.max(A, maxV, maxA);
  const graphScale = graphHeight / (2 * maxVal); // Scale maxVal to half graphHeight

  // Lấy giá trị x, v, a hiện tại để vẽ đường gióng ngang và điểm trên đồ thị
  const xNorm = x * graphScale;
  const vNorm = v * graphScale;
  const aNorm = a * graphScale;

  return (
    <div className="flex flex-col w-full h-full relative p-2 gap-2">
        {/* MAIN VISUAL AREA: CIRCLE + GRAPHS */}
        <div className="flex-1 relative bg-slate-900 rounded-xl overflow-hidden border border-slate-700 flex items-start justify-center p-4">
            <GridBackground />
            
            <HUD title="Giá trị tức thời">
                <div className="grid grid-cols-2 gap-x-4 gap-y-1 text-xs font-mono min-w-[150px]">
                    <span className="text-blue-400 font-bold">x:</span> <span className="text-right text-white">{x.toFixed(2)} cm</span>
                    <span className="text-green-400 font-bold">v:</span> <span className="text-right text-white">{v.toFixed(1)} cm/s</span>
                    <span className="text-red-400 font-bold">a:</span> <span className="text-right text-white">{a.toFixed(1)} cm/s²</span>
                </div>
            </HUD>

            <svg width="100%" height="100%" viewBox="0 0 1200 600" preserveAspectRatio="xMidYMid meet">
                <defs>
                    <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                        <path d="M0,0 L0,6 L9,3 z" fill="#94a3b8" />
                    </marker>
                </defs>
                
                {/* ---------------------------------------------------- */}
                {/* PHẦN 1: MÔ PHỎNG CHUYỂN ĐỘNG TRÒN ĐỀU (PHÓNG TO) */}
                {/* ---------------------------------------------------- */}
                <g transform="translate(-100, 0)">
                    {/* TRỤC TỌA ĐỘ LỚN, RÕ RÀNG */}
                    <line x1="50" y1={cy} x2="500" y2={cy} stroke="#64748b" strokeWidth="2" markerEnd="url(#arrow)" />
                    <text x="510" y={cy+5} fill="#94a3b8" fontSize="16" fontWeight="bold">x</text>
                    
                    {/* VÒNG TRÒN QUỸ ĐẠO - ĐẬM, TƯƠNG PHẢN */}
                    <circle cx={cx} cy={cy} r={A * scale} fill="none" stroke="#475569" strokeWidth="4" strokeDasharray="6 4" />
                    
                    {/* VECTƠ QUAY OM */}
                    <g transform={`rotate(${-((omega * t + phi) * 180 / Math.PI)} ${cx} ${cy})`}>
                        <line x1={cx} y1={cy} x2={cx + A * scale} y2={cy} stroke="white" strokeWidth="4" />
                        <circle cx={cx + A * scale} cy={cy} r="10" fill="#facc15" stroke="white" strokeWidth="3"/>
                        <text x={cx + A * scale + 15} y={cy} fill="#facc15" fontSize="18" fontWeight="bold" transform={`rotate(${((omega * t + phi) * 180 / Math.PI)} ${cx + A * scale} ${cy})`}>M</text>
                    </g>

                    {/* ĐIỂM P (HÌNH CHIẾU) VÀ ĐƯỜNG GIÓNG DỌC */}
                    {/* Đường gióng dọc từ M xuống trục x */}
                    <line x1={cx + x * scale} y1={cy} x2={cx + x * scale} y2={cy - A * scale * Math.sin(omega * t + phi)} stroke={CONSTANTS.colors.marker} strokeWidth="1" strokeDasharray="3 3"/>
                    <circle cx={cx + x * scale} cy={cy} r="12" fill={CONSTANTS.colors.displacement} stroke="white" strokeWidth="3" />
                    <text x={cx + x * scale} y={cy + 35} fill={CONSTANTS.colors.displacement} textAnchor="middle" fontWeight="bold" fontSize="18">P</text>

                    {/* CÁC MỐC BIÊN */}
                    <text x={cx + A * scale} y={cy + 35} fill="white" textAnchor="middle" fontSize="16" fontWeight="bold">+A</text>
                    <text x={cx - A * scale} y={cy + 35} fill="white" textAnchor="middle" fontSize="16" fontWeight="bold">-A</text>
                    <text x={cx - 20} y={cy + 35} fill="white" textAnchor="middle" fontSize="16" fontWeight="bold">O</text>
                </g>

                {/* ---------------------------------------------------- */}
                {/* PHẦN 2: ĐỒ THỊ X, V, A TRÊN CÙNG HỆ TRỤC */}
                {/* ---------------------------------------------------- */}
                <g transform={`translate(${graphX}, ${graphY})`}>
                    
                    {/* TRỤC TỌA ĐỘ ĐỒ THỊ */}
                    <line x1="0" y1={graphHeight / 2} x2={graphWidth} y2={graphHeight / 2} stroke="#64748b" strokeWidth="2" markerEnd="url(#arrow)" /> {/* Trục thời gian t */}
                    <line x1="0" y1="0" x2="0" y2={graphHeight} stroke="#64748b" strokeWidth="2" markerEnd="url(#arrow)" /> {/* Trục giá trị X, V, A */}
                    
                    {/* Nhãn trục */}
                    <text x={graphWidth - 10} y={graphHeight / 2 + 20} fill="#94a3b8" fontSize="14">Thời gian t</text>
                    <text x="15" y="20" fill="#94a3b8" fontSize="14">X, V, A (Chuẩn hóa)</text>

                    {/* Đường gióng ngang (Giá trị max/min) */}
                    <line x1="0" y1="0" x2={graphWidth} y2="0" stroke="#475569" strokeDasharray="2 2" />
                    <line x1="0" y1={graphHeight} x2={graphWidth} y2={graphHeight} stroke="#475569" strokeDasharray="2 2" />
                    <text x="-5" y="10" fill="#475569" textAnchor="end" fontSize="12">Max</text>
                    <text x="-5" y={graphHeight - 5} fill="#475569" textAnchor="end" fontSize="12">Min</text>


                    {/* VẼ ĐỒ THỊ X(T) */}
                    <path 
                        d={`M 0 ${graphHeight / 2 - xNorm} ` + Array.from({length: graphWidth}).map((_, i) => {
                            const tPlot = t - 3 + (i / graphWidth) * 3; // Lùi về quá khứ 3s để có đồ thị
                            const xVal = A * Math.cos(omega * tPlot + phi);
                            return `L ${i} ${graphHeight / 2 - xVal * graphScale}`;
                        }).join(" ")} 
                        fill="none" stroke={CONSTANTS.colors.displacement} strokeWidth="2" 
                    />

                    {/* VẼ ĐỒ THỊ V(T) */}
                    <path 
                        d={`M 0 ${graphHeight / 2 - vNorm} ` + Array.from({length: graphWidth}).map((_, i) => {
                            const tPlot = t - 3 + (i / graphWidth) * 3;
                            const vVal = -omega * A * Math.sin(omega * tPlot + phi);
                            return `L ${i} ${graphHeight / 2 - vVal * graphScale}`;
                        }).join(" ")} 
                        fill="none" stroke={CONSTANTS.colors.velocity} strokeWidth="2" 
                    />
                    
                    {/* VẼ ĐỒ THỊ A(T) */}
                    <path 
                        d={`M 0 ${graphHeight / 2 - aNorm} ` + Array.from({length: graphWidth}).map((_, i) => {
                            const tPlot = t - 3 + (i / graphWidth) * 3;
                            const aVal = -omega * omega * A * Math.cos(omega * tPlot + phi);
                            return `L ${i} ${graphHeight / 2 - aVal * graphScale}`;
                        }).join(" ")} 
                        fill="none" stroke={CONSTANTS.colors.acceleration} strokeWidth="2" 
                    />

                    {/* ĐƯỜNG GIÓNG DỌC T=HIỆN TẠI (t=0 trên trục đồ thị) */}
                    <line x1={graphWidth} y1="0" x2={graphWidth} y2={graphHeight} stroke="yellow" strokeWidth="1" opacity="0.8"/>
                    <text x={graphWidth + 5} y={graphHeight / 2} fill="yellow" fontSize="12" fontWeight="bold">t</text>

                    {/* ĐIỂM HIỆN TẠI TRÊN ĐỒ THỊ */}
                    <circle cx={graphWidth} cy={graphHeight / 2 - xNorm} r="5" fill={CONSTANTS.colors.displacement} stroke="white" strokeWidth="1"/>
                    <circle cx={graphWidth} cy={graphHeight / 2 - vNorm} r="5" fill={CONSTANTS.colors.velocity} stroke="white" strokeWidth="1"/>
                    <circle cx={graphWidth} cy={graphHeight / 2 - aNorm} r="5" fill={CONSTANTS.colors.acceleration} stroke="white" strokeWidth="1"/>

                    {/* LEGENDS */}
                    <g transform="translate(10, -30)" className="text-xs">
                        <circle cx="5" cy="5" r="4" fill={CONSTANTS.colors.displacement} />
                        <text x="15" y="10" fill={CONSTANTS.colors.displacement}>x</text>

                        <circle cx="50" cy="5" r="4" fill={CONSTANTS.colors.velocity} />
                        <text x="60" y="10" fill={CONSTANTS.colors.velocity}>v</text>

                        <circle cx="100" cy="5" r="4" fill={CONSTANTS.colors.acceleration} />
                        <text x="110" y="10" fill={CONSTANTS.colors.acceleration}>a</text>
                    </g>
                </g>

            </svg>
        </div>
    </div>
  );
};

// =================================================================================================
// ZONE 2: CON LẮC LÒ XO (UPDATED: NO BAR CHART, ENHANCED VERTICAL MODE)
// =================================================================================================
const Zone2Spring = ({ t, params }) => {
    const [mode, setMode] = useState('vertical'); 
    const { A, phi, k, m } = params;
    const omega = Math.sqrt(k/m); 
    const x = A * Math.cos(omega * t + phi);
    const v = -omega * A * Math.sin(omega * t + phi);

    // Visual params
    const scale = 18; // Phóng to hơn
    const l0 = 120; 
    const deltaL = (m * CONSTANTS.g / k) * 100; // cm
    const floorY = 350; 

    return (
        <div className="flex flex-col w-full h-full relative p-2">
            <div className="flex-1 bg-slate-900 rounded-xl border border-slate-700 relative overflow-hidden flex flex-col items-center justify-center shadow-inner">
                 <GridBackground />
                 
                 {/* CONTROLS */}
                 <div className="absolute top-4 left-4 flex gap-2 z-10">
                     <button onClick={()=>setMode('horizontal')} className={`px-3 py-1.5 text-xs font-bold rounded shadow transition-all ${mode==='horizontal'?'bg-blue-600 text-white scale-105':'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}>Nằm Ngang</button>
                     <button onClick={()=>setMode('vertical')} className={`px-3 py-1.5 text-xs font-bold rounded shadow transition-all ${mode==='vertical'?'bg-blue-600 text-white scale-105':'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}>Thẳng Đứng</button>
                 </div>

                 <HUD>
                    <div className="grid grid-cols-1 gap-1 text-xs font-mono min-w-[120px]">
                        <div className="flex justify-between"><span className="text-blue-400 font-bold">x:</span> <span className="text-white">{x.toFixed(2)} cm</span></div>
                        <div className="flex justify-between"><span className="text-green-400 font-bold">v:</span> <span className="text-white">{v.toFixed(1)} cm/s</span></div>
                        <div className="flex justify-between border-t border-slate-600 pt-1 mt-1"><span className="text-slate-400">Δl₀:</span> <span className="text-white">{deltaL.toFixed(1)} cm</span></div>
                    </div>
                 </HUD>

                 <svg width="100%" height="100%" viewBox="0 0 800 500">
                     <defs>
                         <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                             <path d="M0,0 L0,6 L9,3 z" fill="#94a3b8" />
                         </marker>
                     </defs>
                     {mode === 'horizontal' ? (
                         <>
                            <rect x="50" y="150" width="20" height="200" fill="#475569" rx="2" />
                            <line x1="50" y1={floorY} x2="750" y2={floorY} stroke="#94a3b8" strokeWidth="3" />
                            <rect x="50" y={floorY} width="700" height="50" fill="url(#smallGrid)" opacity="0.3"/>
                            
                            {/* MARKERS */}
                            <line x1={80+l0} y1="180" x2={80+l0} y2={floorY+30} stroke="white" strokeDasharray="6 4" strokeWidth="1"/>
                            <text x={80+l0} y={floorY+45} fill="white" textAnchor="middle" fontWeight="bold" fontSize="14">O (VTCB)</text>
                            
                            <line x1={80+l0-A*scale} y1="200" x2={80+l0-A*scale} y2={floorY+20} stroke="#ef4444" strokeDasharray="2 2"/>
                            <text x={80+l0-A*scale} y={floorY+35} fill="#ef4444" textAnchor="middle" fontSize="12" fontWeight="bold">-A</text>
                            
                            <line x1={80+l0+A*scale} y1="200" x2={80+l0+A*scale} y2={floorY+20} stroke="#ef4444" strokeDasharray="2 2"/>
                            <text x={80+l0+A*scale} y={floorY+35} fill="#ef4444" textAnchor="middle" fontSize="12" fontWeight="bold">+A</text>

                            {/* SPRING */}
                            <path d={`M 70 ${floorY-60} ` + Array.from({length: 30}).map((_,i) => {
                                const len = (l0 + x*scale);
                                const step = len / 30;
                                return `L ${70 + step * (i + 0.5)} ${floorY - 60 + (i%2===0?20:-20)}`;
                            }).join(" ") + ` L ${80+l0+x*scale} ${floorY-60}`} fill="none" stroke={CONSTANTS.colors.spring} strokeWidth="3" />
                            
                            {/* BLOCK */}
                            <rect x={80+l0+x*scale} y={floorY-100} width="80" height="80" fill={CONSTANTS.colors.displacement} rx="8" stroke="white" strokeWidth="2"/>
                            <text x={80+l0+x*scale+40} y={floorY-55} fill="white" textAnchor="middle" fontWeight="bold" fontSize="16">m</text>
                         </>
                     ) : (
                         <>
                            <g transform="translate(100, 0)">
                                <rect x="300" y="20" width="200" height="15" fill="#475569" rx="2" />
                                
                                {/* 1. VỊ TRÍ TỰ NHIÊN (l0) */}
                                <line x1="300" y1={35+l0} x2="550" y2={35+l0} stroke="#94a3b8" strokeDasharray="4 4"/>
                                <text x="560" y={35+l0+4} fill="#94a3b8" fontSize="12" fontStyle="italic">l₀ (Tự nhiên)</text>

                                {/* 2. VỊ TRÍ CÂN BẰNG (O) */}
                                <line x1="300" y1={35+l0+deltaL} x2="550" y2={35+l0+deltaL} stroke="white" strokeDasharray="8 4" strokeWidth="1.5"/>
                                <text x="560" y={35+l0+deltaL+4} fill="white" fontWeight="bold" fontSize="14">O (VTCB)</text>
                                
                                {/* 3. MŨI TÊN Δl0 */}
                                <line x1="280" y1={35+l0} x2="280" y2={35+l0+deltaL} stroke="#eab308" strokeWidth="1.5" markerEnd="url(#arrow)"/>
                                <text x="260" y={35+l0+deltaL/2+4} fill="#eab308" fontSize="12" fontWeight="bold">Δl₀</text>

                                {/* 4. BIÊN ĐỘ (+A, -A) */}
                                <line x1="350" y1={35+l0+deltaL-A*scale} x2="450" y2={35+l0+deltaL-A*scale} stroke="#ef4444" strokeDasharray="2 2"/>
                                <text x="460" y={35+l0+deltaL-A*scale+4} fill="#ef4444" fontSize="12" fontWeight="bold">-A (Biên âm)</text>

                                <line x1="350" y1={35+l0+deltaL+A*scale} x2="450" y2={35+l0+deltaL+A*scale} stroke="#ef4444" strokeDasharray="2 2"/>
                                <text x="460" y={35+l0+deltaL+A*scale+4} fill="#ef4444" fontSize="12" fontWeight="bold">+A (Biên dương)</text>

                                {/* SPRING */}
                                <path d={`M 400 35 ` + Array.from({length: 30}).map((_,i) => {
                                    const len = (l0 + deltaL + x*scale);
                                    const step = len / 30;
                                    return `L ${400 + (i%2===0?15:-15)} ${35 + step * (i + 0.5)}`;
                                }).join(" ") + ` L 400 ${35+l0+deltaL+x*scale}`} fill="none" stroke={CONSTANTS.colors.spring} strokeWidth="3" />
                                
                                {/* BLOCK */}
                                <rect x={360} y={35+l0+deltaL+x*scale} width="80" height="80" fill={CONSTANTS.colors.displacement} rx="8" stroke="white" strokeWidth="2"/>
                                <text x={400} y={35+l0+deltaL+x*scale+45} fill="white" textAnchor="middle" fontWeight="bold" fontSize="16">m</text>
                            </g>
                         </>
                     )}
                 </svg>
            </div>
        </div>
    );
};

// =================================================================================================
// ZONE 3: CON LẮC ĐƠN (UPDATED: REFINED VISUALS)
// =================================================================================================
const Zone3Pendulum = ({ t, params }) => {
    const { A, phi, l } = params;
    const omega = Math.sqrt(CONSTANTS.g/l);
    const alpha0 = (A * Math.PI) / 180;
    const alpha = alpha0 * Math.cos(omega * t + phi);
    
    // Coords
    const pivotX = 400; 
    const pivotY = 30;
    const lenPx = 350; // Dây dài hơn cho rõ
    const bobX = pivotX + lenPx * Math.sin(alpha);
    const bobY = pivotY + lenPx * Math.cos(alpha);

    return (
        <div className="flex flex-col w-full h-full gap-2 relative p-2">
             <div className="flex-[4] bg-slate-900 rounded-xl border border-slate-700 relative overflow-hidden flex items-center justify-center shadow-inner">
                 <GridBackground />
                 <HUD>
                    <div className="text-xs font-mono text-right text-slate-300">
                        α: <span className="text-white font-bold">{(alpha*180/Math.PI).toFixed(2)}°</span><br/>
                        s: <span className="text-blue-400">{(alpha*l*100).toFixed(2)} cm</span>
                    </div>
                 </HUD>

                 <svg width="100%" height="100%" viewBox="0 0 800 500">
                     <defs>
                         <radialGradient id="bobGrad">
                             <stop offset="0%" stopColor="#60a5fa" />
                             <stop offset="100%" stopColor="#1d4ed8" />
                         </radialGradient>
                         <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                             <path d="M0,0 L0,6 L9,3 z" fill="#94a3b8" />
                         </marker>
                     </defs>
                     
                     {/* CUNG QUỸ ĐẠO & THƯỚC ĐO ĐỘ */}
                     <path d={`M ${pivotX - lenPx*Math.sin(alpha0)} ${pivotY + lenPx*Math.cos(alpha0)} Q ${pivotX} ${pivotY + lenPx + 30} ${pivotX + lenPx*Math.sin(alpha0)} ${pivotY + lenPx*Math.cos(alpha0)}`} fill="none" stroke="#475569" strokeDasharray="4 4" strokeWidth="2" />
                     <line x1={pivotX} y1={pivotY} x2={pivotX} y2={pivotY+400} stroke="#475569" strokeDasharray="6 4"/>
                     
                     {/* GIÁ TREO */}
                     <path d="M 250 30 L 550 30" stroke="#94a3b8" strokeWidth="6" strokeLinecap="round"/>
                     <path d="M 300 0 L 320 30 M 350 0 L 370 30 M 400 0 L 420 30 M 450 0 L 470 30 M 500 0 L 520 30" stroke="#64748b" strokeWidth="2"/>

                     {/* DÂY TREO */}
                     <line x1={pivotX} y1={pivotY} x2={bobX} y2={bobY} stroke="white" strokeWidth="3"/>
                     
                     {/* VẬT NẶNG */}
                     <circle cx={bobX} cy={bobY} r={25} fill="url(#bobGrad)" stroke="white" strokeWidth="2" filter="drop-shadow(0 0 5px rgba(59, 130, 246, 0.5))"/>
                     
                     {/* VECTƠ LỰC (OPTIONAL) - Adding gravity vector */}
                     <line x1={bobX} y1={bobY} x2={bobX} y2={bobY + 60} stroke="#ef4444" strokeWidth="2" markerEnd="url(#arrow)"/>
                     <text x={bobX + 5} y={bobY + 60} fill="#ef4444" fontSize="12" fontWeight="bold">P</text>
                 </svg>
             </div>
        </div>
    );
};

// =================================================================================================
// ZONE 4: TẮT DẦN (UPDATED: ENVIRONMENTS)
// =================================================================================================
const Zone4Damped = ({ t, params }) => {
    const { A, f, phi } = params;
    const [env, setEnv] = useState('air');
    
    // Môi trường & Hệ số tắt dần
    const ENVIRONMENTS = {
        vacuum: { name: 'Chân không', beta: 0, color: '#64748b' },
        air:    { name: 'Không khí', beta: 0.05, color: '#bae6fd' },
        water:  { name: 'Nước',     beta: 0.3,  color: '#3b82f6' },
        oil:    { name: 'Dầu',      beta: 0.8,  color: '#eab308' }
    };

    const beta = ENVIRONMENTS[env].beta;
    const omega = 2 * Math.PI * f;
    const x = A * Math.exp(-beta * t) * Math.cos(omega * t + phi);
    
    return (
        <div className="w-full h-full bg-slate-900 rounded-xl border border-slate-700 p-4 relative flex flex-col gap-4">
            
            {/* Environment Selector */}
            <div className="flex justify-center gap-4 bg-slate-800 p-2 rounded-lg">
                {Object.keys(ENVIRONMENTS).map(key => (
                    <button 
                        key={key}
                        onClick={() => setEnv(key)}
                        className={`px-4 py-2 rounded font-bold transition-all text-sm flex items-center gap-2
                            ${env === key 
                                ? 'bg-blue-600 text-white shadow-lg scale-105' 
                                : 'bg-slate-700 text-slate-400 hover:bg-slate-600'}`}
                    >
                        <div className="w-3 h-3 rounded-full" style={{backgroundColor: ENVIRONMENTS[key].color}}></div>
                        {ENVIRONMENTS[key].name}
                    </button>
                ))}
            </div>

            <div className="flex-1 relative border border-slate-700 bg-black rounded-lg overflow-hidden shadow-inner">
                <GridBackground />
                <div className="absolute top-2 left-2 text-xs font-mono text-slate-400">
                    Môi trường: <span className="text-white font-bold">{ENVIRONMENTS[env].name}</span> | 
                    Hệ số tắt dần β: <span className="text-red-400 font-bold">{beta}</span>
                </div>

                <svg width="100%" height="100%" viewBox="0 0 1000 400" preserveAspectRatio="none">
                    <line x1="0" y1="200" x2="1000" y2="200" stroke="#475569" strokeWidth="2"/>
                    
                    {/* ENVELOPE (ĐƯỜNG BAO) */}
                    {beta > 0 && (
                        <>
                            <path d={`M 0 200 ` + Array.from({length: 400}).map((_,i) => {
                                const tPlot = i * 0.05;
                                return `L ${i*2.5} ${200 - (A*Math.exp(-beta*tPlot))*30}`;
                            }).join(" ")} fill="none" stroke="#ef4444" strokeDasharray="4 4" opacity="0.4" strokeWidth="1"/>
                            <path d={`M 0 200 ` + Array.from({length: 400}).map((_,i) => {
                                const tPlot = i * 0.05;
                                return `L ${i*2.5} ${200 + (A*Math.exp(-beta*tPlot))*30}`;
                            }).join(" ")} fill="none" stroke="#ef4444" strokeDasharray="4 4" opacity="0.4" strokeWidth="1"/>
                        </>
                    )}

                    {/* WAVE GRAPH */}
                    <path d={`M 0 200 ` + Array.from({length: 500}).map((_,i) => {
                        const tPlot = i * 0.05;
                        const val = A * Math.exp(-beta * tPlot) * Math.cos(omega * tPlot + phi);
                        return `L ${i*2} ${200 - val * 30}`;
                    }).join(" ")} fill="none" stroke={ENVIRONMENTS[env].color} strokeWidth="2.5" filter="drop-shadow(0 0 4px currentColor)"/>
                    
                    {/* CURRENT POINT */}
                    <circle cx={t/0.05 * 2} cy={200 - x*30} r="6" fill="#facc15" stroke="white" strokeWidth="2"/>
                </svg>
            </div>
        </div>
    );
};

// =================================================================================================
// ZONE 5, 6: SÓNG CƠ & ÂM (UPDATED VISUALS)
// =================================================================================================

const Zone5Wave = ({ t, params }) => {
    const { A, f } = params;
    const v = 50; 
    const lambda = v / f;
    const omega = 2 * Math.PI * f;
    const k = 2 * Math.PI / lambda;

    return (
        <div className="flex flex-col h-full gap-4 p-4">
            <div className="flex-1 bg-slate-900 border border-slate-700 rounded-xl relative overflow-hidden flex flex-col items-center justify-center">
                <GridBackground />
                <div className="absolute top-2 left-2 px-3 py-1 text-xs font-bold text-white bg-blue-600 rounded shadow">Sóng Ngang (Transverse)</div>
                <svg width="100%" height="100%" viewBox="0 0 800 400">
                    <defs>
                        <linearGradient id="waveGradient" x1="0" x2="0" y1="0" y2="1">
                            <stop offset="0%" stopColor="#3b82f6" stopOpacity="0.8"/>
                            <stop offset="100%" stopColor="#3b82f6" stopOpacity="0"/>
                        </linearGradient>
                         <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                             <path d="M0,0 L0,6 L9,3 z" fill="#94a3b8" />
                         </marker>
                    </defs>
                    <line x1="0" y1="200" x2="800" y2="200" stroke="#475569" strokeWidth="2" strokeDasharray="6 4"/>
                    
                    {/* Wave Path */}
                    <path d={`M 0 200 ` + Array.from({length: 200}).map((_, i) => {
                        const x = i * 4;
                        const u = A * Math.cos(omega * t - k * x);
                        return `L ${x} ${200 - u * 8}`;
                    }).join(" ")} fill="none" stroke="#3b82f6" strokeWidth="3" filter="drop-shadow(0 0 5px #3b82f6)"/>

                    {/* Particles */}
                    {Array.from({length: 40}).map((_, i) => {
                        const x = i * 20 + 10; 
                        const u = A * Math.cos(omega * t - k * x);
                        return (
                            <g key={i}>
                                <line x1={x} y1={200} x2={x} y2={200 - u * 8} stroke="#475569" strokeWidth="1" opacity="0.5"/>
                                <circle cx={x} cy={200 - u * 8} r={4} fill={i%2===0 ? "#ef4444" : "#10b981"} stroke="white" strokeWidth="1" />
                            </g>
                        );
                    })}
                </svg>
            </div>
        </div>
    );
};

const Zone6Sound = ({ t, params }) => {
    const { f } = params;
    const v = 60; 
    const lambda = v / f;
    const omega = 2 * Math.PI * f;
    const k = 2 * Math.PI / lambda;
    
    return (
        <div className="flex flex-col h-full gap-4 p-4">
             <div className="flex-1 bg-slate-900 border border-slate-700 rounded-xl relative overflow-hidden flex flex-col justify-center items-center">
                 <div className="absolute top-2 left-2 px-3 py-1 text-xs font-bold text-white bg-green-600 rounded shadow">Sóng Dọc (Longitudinal)</div>
                 <div className="w-full max-w-5xl h-60 relative bg-black/50 rounded border border-slate-600 overflow-hidden flex items-center">
                     <svg width="100%" height="100%">
                         {Array.from({length: 300}).map((_, i) => {
                             const row = Math.floor(i / 50); // 6 rows
                             const col = i % 50;
                             const xEquilibrium = col * 25 + 20;
                             const y = row * 40 + 20;
                             const displacement = 15 * Math.cos(omega * t - k * xEquilibrium);
                             return (
                                 <circle key={i} cx={xEquilibrium + displacement} cy={y} r={3} fill="#f1f5f9" opacity="0.9"/>
                             )
                         })}
                     </svg>
                 </div>
                 <div className="mt-4 text-center text-slate-400 text-sm">
                     Các hạt môi trường dao động song song với phương truyền sóng, tạo ra các miền <span className="text-white font-bold">Nén (đậm đặc)</span> và <span className="text-white font-bold">Dãn (thưa)</span>.
                 </div>
             </div>
        </div>
    );
};

// =================================================================================================
// ZONE 7: GIAO THOA (REBUILT WATER & LIGHT)
// =================================================================================================
const Zone7Interference = ({ t, params }) => {
    const [mode, setMode] = useState('water'); 
    const [lightType, setLightType] = useState('mono');
    const [lambda1, setLambda1] = useState(600); // nm
    const [lambda2, setLambda2] = useState(500); // nm
    const [freqWater, setFreqWater] = useState(15); 

    const nmToCSS = (nm) => {
        if(nm < 400) return '#4b0082';
        if(nm < 450) return '#0000ff';
        if(nm < 490) return '#00aaff';
        if(nm < 560) return '#00ff00';
        if(nm < 590) return '#ffff00';
        if(nm < 635) return '#ff8800';
        return '#ff0000';
    };

    return (
        <div className="flex w-full h-full gap-4 p-2">
            <div className="w-64 bg-slate-900 border border-slate-700 p-4 rounded-xl flex flex-col gap-4 overflow-y-auto shrink-0 shadow-lg">
                <div className="flex rounded bg-slate-800 p-1">
                    <button onClick={()=>setMode('water')} className={`flex-1 py-1.5 text-xs font-bold rounded transition-colors ${mode==='water'?'bg-blue-600 text-white':'text-slate-400 hover:text-white'}`}>Sóng Nước</button>
                    <button onClick={()=>setMode('light')} className={`flex-1 py-1.5 text-xs font-bold rounded transition-colors ${mode==='light'?'bg-purple-600 text-white':'text-slate-400 hover:text-white'}`}>Ánh Sáng</button>
                </div>

                {mode === 'water' && (
                    <div className="space-y-4">
                        <div>
                            <div className="text-xs text-slate-400 mb-1 flex justify-between"><span>Tần số nguồn (Hz)</span><span className="text-white">{freqWater}</span></div>
                            <input type="range" min="5" max="30" value={freqWater} onChange={(e)=>setFreqWater(Number(e.target.value))} className="w-full accent-blue-500"/>
                        </div>
                        <div className="text-xs text-slate-500 italic p-2 bg-slate-800 rounded border border-slate-700">
                            Quan sát các vân cực đại (sáng) và cực tiểu (tối) hình hyperbol do hai nguồn đồng bộ tạo ra.
                        </div>
                    </div>
                )}

                {mode === 'light' && (
                    <div className="space-y-4">
                        <select value={lightType} onChange={(e)=>setLightType(e.target.value)} className="w-full bg-slate-800 border border-slate-600 text-xs text-white p-2 rounded focus:outline-none focus:border-blue-500">
                            <option value="mono">Đơn sắc (1 λ)</option>
                            <option value="dual">Hai bức xạ (2 λ)</option>
                            <option value="white">Ánh sáng trắng</option>
                        </select>

                        {(lightType === 'mono' || lightType === 'dual') && (
                            <div>
                                <div className="text-xs text-slate-400 mb-1 flex justify-between"><span>Lambda 1 (nm)</span><span style={{color: nmToCSS(lambda1)}}>{lambda1}</span></div>
                                <input type="range" min="380" max="760" value={lambda1} onChange={(e)=>setLambda1(Number(e.target.value))} className="w-full" style={{accentColor: nmToCSS(lambda1)}}/>
                            </div>
                        )}

                        {lightType === 'dual' && (
                            <div>
                                <div className="text-xs text-slate-400 mb-1 flex justify-between"><span>Lambda 2 (nm)</span><span style={{color: nmToCSS(lambda2)}}>{lambda2}</span></div>
                                <input type="range" min="380" max="760" value={lambda2} onChange={(e)=>setLambda2(Number(e.target.value))} className="w-full" style={{accentColor: nmToCSS(lambda2)}}/>
                            </div>
                        )}
                    </div>
                )}
            </div>

            <div className="flex-1 bg-black border border-slate-700 rounded-xl relative overflow-hidden flex items-center justify-center shadow-inner">
                {mode === 'water' ? (
                      <div className="w-full h-full relative overflow-hidden bg-slate-900">
                          {/* SỬ DỤNG SVG PATTERN ĐỂ TẠO HIỆU ỨNG MOIRÉ GIAO THOA */}
                          <svg width="100%" height="100%">
                              <defs>
                                  <pattern id="ripple" x="0" y="0" width={100/freqWater} height={100/freqWater} patternUnits="userSpaceOnUse">
                                      <circle cx={50/freqWater} cy={50/freqWater} r={50/freqWater - 2} fill="none" stroke="rgba(59, 130, 246, 0.5)" strokeWidth="2" />
                                  </pattern>
                              </defs>
                              
                              {/* NGUỒN S1 */}
                              <circle cx="30%" cy="50%" r="200%" fill="none" stroke="rgba(255,255,255,0.3)" strokeWidth="1" strokeDasharray={`4, ${150/freqWater}`}/>
                              
                              {/* Dùng nhiều vòng tròn đồng tâm mở rộng để tạo hiệu ứng */}
                              {Array.from({length: 20}).map((_, i) => (
                                  <circle key={`s1-${i}`} cx="30%" cy="50%" r={(t*10 + i * 20) % 800} fill="none" stroke="rgba(255,255,255,0.3)" strokeWidth="2" />
                              ))}
                              {Array.from({length: 20}).map((_, i) => (
                                  <circle key={`s2-${i}`} cx="70%" cy="50%" r={(t*10 + i * 20) % 800} fill="none" stroke="rgba(255,255,255,0.3)" strokeWidth="2" />
                              ))}

                              <circle cx="30%" cy="50%" r="5" fill="#ef4444" />
                              <text x="29%" y="48%" fill="white" fontSize="12">S1</text>
                              <circle cx="70%" cy="50%" r="5" fill="#ef4444" />
                              <text x="69%" y="48%" fill="white" fontSize="12">S2</text>
                          </svg>
                          <div className="absolute top-2 left-2 text-xs text-blue-500 font-bold bg-black/50 px-2 py-1 rounded">GIAO THOA SÓNG NƯỚC</div>
                      </div>
                ) : (
                    <div className="w-full h-full relative flex flex-col items-center justify-center">
                        <div className="absolute top-2 left-2 text-xs text-white font-bold bg-black/50 p-1 rounded z-20">MÀN HỨNG VÂN (Y-ÂNG)</div>
                        
                        {/* Simulation Area */}
                        <div className="w-[90%] h-[200px] border-y-2 border-slate-700 bg-black relative overflow-hidden flex items-center">
                            
                            {/* MARKER VÂN TRUNG TÂM */}
                            <div className="absolute left-1/2 top-0 bottom-0 w-0.5 bg-red-500/50 z-20 flex flex-col justify-end border-l border-dashed border-red-500">
                                <span className="text-[10px] text-red-400 font-bold -ml-4 mb-2 bg-black/80 px-1 rounded">k=0</span>
                            </div>
                            
                            {/* THƯỚC ĐO */}
                            <div className="absolute bottom-0 left-0 right-0 h-4 bg-slate-800 z-20 flex justify-between px-2">
                                {[...Array(11)].map((_,i) => <div key={i} className="w-px h-full bg-slate-500"></div>)}
                            </div>

                            {/* TYPE 1: MONO */}
                            {lightType === 'mono' && (
                                <div className="w-full h-full" style={{
                                    background: `repeating-linear-gradient(90deg, black 0%, ${nmToCSS(lambda1)} 5%, black 10%)`,
                                    backgroundSize: `${lambda1/10}px 100%`,
                                    backgroundPosition: 'center',
                                    filter: 'blur(2px)'
                                }}/>
                            )}

                            {/* TYPE 2: DUAL */}
                            {lightType === 'dual' && (
                                <div className="w-full h-full relative">
                                    <div className="absolute inset-0" style={{
                                        background: `repeating-linear-gradient(90deg, black 0%, ${nmToCSS(lambda1)} 5%, black 10%)`,
                                        backgroundSize: `${lambda1/10}px 100%`,
                                        backgroundPosition: 'center',
                                        mixBlendMode: 'screen',
                                        filter: 'blur(2px)'
                                    }}/>
                                    <div className="absolute inset-0" style={{
                                        background: `repeating-linear-gradient(90deg, black 0%, ${nmToCSS(lambda2)} 5%, black 10%)`,
                                        backgroundSize: `${lambda2/10}px 100%`,
                                        backgroundPosition: 'center',
                                        mixBlendMode: 'screen',
                                        filter: 'blur(2px)'
                                    }}/>
                                </div>
                            )}

                             {/* TYPE 3: WHITE */}
                            {lightType === 'white' && (
                                <div className="w-full h-full relative">
                                     <div className="absolute inset-0" style={{
                                         background: `linear-gradient(90deg, 
                                             black 0%, 
                                             rgba(255,0,0,0.5) 30%, 
                                             rgba(0,255,0,0.5) 40%, 
                                             rgba(0,0,255,0.5) 45%, 
                                             white 50%, 
                                             rgba(0,0,255,0.5) 55%, 
                                             rgba(0,255,0,0.5) 60%, 
                                             rgba(255,0,0,0.5) 70%, 
                                             black 100%)`,
                                         filter: 'blur(4px)'
                                     }}/>
                                </div>
                            )}
                        </div>
                    </div>
                )}
            </div>
        </div>
    );
};

// =================================================================================================
// ZONE 8: SÓNG DỪNG (UPDATED: FIXED/FREE ENDS + SLIDERS)
// =================================================================================================
const Zone8Standing = ({ t, params }) => {
    // Local params for interactive exploration
    const [freq, setFreq] = useState(20);
    const [length, setLength] = useState(100); // cm
    const [endType, setEndType] = useState('fixed'); // 'fixed' | 'free'

    const v = 2000; // cm/s (giả định tốc độ truyền sóng lớn để nhìn rõ)
    const lambda = v / freq;
    const omega = 2 * Math.PI * freq;
    const k = 2 * Math.PI / lambda;
    
    // Điều kiện sóng dừng
    // 2 đầu cố định: L = k * lambda/2
    // 1 cố định 1 tự do: L = (2k+1) * lambda/4
    
    // Tính toán số bụng sóng lý thuyết để hiển thị thông tin
    const numLoops = endType === 'fixed' 
        ? (2 * length) / lambda 
        : (4 * length) / lambda - 0.5;

    return (
         <div className="flex flex-col h-full gap-4 p-2">
             {/* CONTROLS */}
             <div className="flex gap-4 bg-slate-900 border border-slate-700 p-3 rounded-xl items-center flex-wrap">
                 <div className="flex gap-1 bg-slate-800 p-1 rounded">
                     <button onClick={()=>setEndType('fixed')} className={`px-3 py-1 text-xs font-bold rounded ${endType==='fixed'?'bg-blue-600 text-white':'text-slate-400'}`}>2 Đầu Cố Định</button>
                     <button onClick={()=>setEndType('free')} className={`px-3 py-1 text-xs font-bold rounded ${endType==='free'?'bg-blue-600 text-white':'text-slate-400'}`}>1 Cố Định, 1 Tự Do</button>
                 </div>
                 
                 <div className="flex items-center gap-2 flex-1">
                     <span className="text-xs text-slate-400">Tần số (f):</span>
                     <input type="range" min="10" max="100" value={freq} onChange={(e)=>setFreq(Number(e.target.value))} className="accent-green-500 flex-1"/>
                     <span className="text-xs text-green-400 font-mono w-10">{freq}Hz</span>
                 </div>

                 <div className="flex items-center gap-2 flex-1">
                     <span className="text-xs text-slate-400">Chiều dài (L):</span>
                     <input type="range" min="50" max="150" value={length} onChange={(e)=>setLength(Number(e.target.value))} className="accent-orange-500 flex-1"/>
                     <span className="text-xs text-orange-400 font-mono w-12">{length}cm</span>
                 </div>
             </div>

            <div className="flex-1 bg-slate-900 border border-slate-700 rounded-xl relative overflow-hidden flex items-center justify-center shadow-inner">
                 <GridBackground />
                 <div className="absolute top-2 left-2 text-xs font-bold text-slate-500">
                     Số bụng sóng lý thuyết: <span className="text-white">{numLoops.toFixed(2)}</span>
                 </div>

                 {/* VISUALIZATION */}
                 <svg width="800" height="300" viewBox="0 0 800 300" className="bg-slate-800/30 rounded border border-slate-700/50">
                     {/* String Visual */}
                     <path d={`M 50 150 ` + Array.from({length: 400}).map((_, i) => {
                         const x_visual = i * (700/400); // Draw width 700px
                         const x_phys = (x_visual / 700) * length; // Map to physical length
                         
                         let u = 0;
                         if (endType === 'fixed') {
                             // Standing wave eq: 2A sin(kx) cos(wt)
                             u = 40 * Math.sin(k * x_phys) * Math.cos(omega * t);
                         } else {
                             // Fixed at x=0, Free at x=L. Eq: 2A sin(k*x) * cos(omega*t)
                             u = 40 * Math.sin(k * x_phys) * Math.cos(omega * t);
                         }
                         
                         return `L ${50 + x_visual} ${150 - u}`;
                     }).join(" ")} fill="none" stroke={CONSTANTS.colors.mechanical} strokeWidth="3" filter="drop-shadow(0 0 5px #ec4899)"/>
                     
                     {/* NODES MARKERS */}
                     <circle cx="50" cy="150" r="4" fill="white"/> {/* Nguồn/Cố định */}
                     
                     {endType === 'fixed' ? (
                         <circle cx="750" cy="150" r="4" fill="white"/> 
                     ) : (
                         <circle cx="750" cy="150" r="4" fill="none" stroke="white" strokeWidth="2"/> // Vòng trượt
                     )}

                     {/* Ruler visual */}
                     <line x1="50" y1="200" x2="750" y2="200" stroke="#64748b" strokeWidth="1"/>
                     <text x="400" y="220" fill="#64748b" textAnchor="middle" fontSize="12">Chiều dài dây L = {length} cm (Scale Visual)</text>
                 </svg>
            </div>
         </div>
    );
}

// --- MAIN APP COMPONENT ---
export default function PhysicsLab() {
    const [activeZone, setActiveZone] = useState(1); // Mở Zone 1 mặc định
    const [t, setT] = useState(0);
    const [isRunning, setIsRunning] = useState(false);
    
    // Global Physics Params
    const [params, setParams] = useState({
        A: 5,       // Amplitude (cm)
        f: 1,       // Frequency (Hz)
        phi: 0,     // Phase constant (rad)
        k: 40,      // Spring constant (N/m)
        m: 0.2,     // Mass (kg)
        l: 1,       // Length (m) for pendulum
    });

    useEffect(() => {
        let frameId;
        const loop = () => {
            if (isRunning) {
                setT(prev => prev + 0.015); // Speed up slightly
            }
            frameId = requestAnimationFrame(loop);
        };
        frameId = requestAnimationFrame(loop);
        return () => cancelAnimationFrame(frameId);
    }, [isRunning]);

    const updateParam = (key, value) => {
        setParams(prev => ({ ...prev, [key]: parseFloat(value) }));
    };

    const renderActiveZone = () => {
        const props = { t, params, setParams };
        switch(activeZone) {
            case 0: return <Zone0Dashboard />;
            case 1: return <Zone1Harmonic {...props} />;
            case 2: return <Zone2Spring {...props} />;
            case 3: return <Zone3Pendulum {...props} />;
            case 4: return <Zone4Damped {...props} />;
            case 5: return <Zone5Wave {...props} />;
            case 6: return <Zone6Sound {...props} />;
            case 7: return <Zone7Interference {...props} />;
            case 8: return <Zone8Standing {...props} />;
            default: return <Zone0Dashboard />;
        }
    };

    // Controls visibility logic
    const showAmplitude = [1, 2, 3, 4, 5].includes(activeZone);
    const showFrequency = [1, 4, 5, 6].includes(activeZone); // Zone 8 has internal freq
    const showPhase = [1, 2, 3, 4].includes(activeZone);
    const showSpringK = activeZone === 2;
    const showMass = [2, 3].includes(activeZone);
    const showLength = activeZone === 3;

    return (
        <div className="flex flex-col h-screen bg-slate-950 text-slate-100 font-sans overflow-hidden select-none">
            {/* 1. Header Navigation */}
            <div className="h-16 bg-slate-900 border-b border-slate-800 flex items-center px-4 shadow-md shrink-0 overflow-x-auto no-scrollbar">
                <div className="flex gap-2">
                    {ZONES.map(zone => {
                        const Icon = zone.icon;
                        const isActive = activeZone === zone.id;
                        return (
                            <button
                                key={zone.id}
                                onClick={() => { setActiveZone(zone.id); setIsRunning(false); setT(0); }}
                                className={`flex items-center gap-2 px-3 py-2 rounded-lg text-sm font-medium transition-all whitespace-nowrap
                                    ${isActive 
                                        ? 'bg-blue-600 text-white shadow-lg shadow-blue-900/50' 
                                        : 'bg-slate-800 text-slate-400 hover:bg-slate-700 hover:text-slate-200'
                                    }`}
                            >
                                <Icon size={16} />
                                {zone.name}
                            </button>
                        );
                    })}
                </div>
            </div>

            {/* 2. Main Content Area */}
            <div className="flex-1 overflow-hidden relative bg-black/20">
                {renderActiveZone()}
            </div>

            {/* 3. Control Footer */}
            <div className="h-auto min-h-[80px] bg-slate-900 border-t border-slate-800 p-4 shrink-0 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.3)] z-50">
                <div className="max-w-7xl mx-auto flex flex-col md:flex-row items-center gap-6">
                    
                    {/* Playback Controls */}
                    <div className="flex items-center gap-4 bg-slate-950 p-2 rounded-full border border-slate-800 shadow-inner">
                        <button onClick={() => setT(0)} className="p-2 text-slate-400 hover:text-white transition-colors" title="Reset Time">
                            <RotateCcw size={20} />
                        </button>
                        <button onClick={() => setT(t => t - 0.05)} className="p-2 text-slate-400 hover:text-white" title="-0.05s">
                            <SkipBack size={20} />
                        </button>
                        <button 
                            onClick={() => setIsRunning(!isRunning)} 
                            className={`p-3 rounded-full transition-all transform hover:scale-105 ${isRunning ? 'bg-red-500 hover:bg-red-600 text-white shadow-red-500/50' : 'bg-green-500 hover:bg-green-600 text-white shadow-green-500/50'} shadow-lg`}
                        >
                            {isRunning ? <Pause size={24} fill="currentColor"/> : <Play size={24} fill="currentColor" className="ml-1"/>}
                        </button>
                        <button onClick={() => setT(t => t + 0.05)} className="p-2 text-slate-400 hover:text-white" title="+0.05s">
                            <SkipForward size={20} />
                        </button>
                         <div className="w-20 text-center font-mono text-xl text-blue-400 font-bold border-l border-slate-800 pl-4">
                            {t.toFixed(2)}s
                        </div>
                    </div>

                    {/* Parameter Sliders */}
                    <div className="flex-1 grid grid-cols-2 md:grid-cols-4 gap-4 w-full">
                         {activeZone === 0 && <div className="text-slate-500 text-sm italic col-span-4 text-center">Chào mừng đến với PhysLab Pro. Hãy chọn bài học phía trên!</div>}
                         
                         {showAmplitude && (
                            <div className="flex flex-col gap-1">
                                <label className="flex justify-between text-xs font-bold text-slate-400">
                                    Biên độ A (cm) <span className="text-white">{params.A}</span>
                                </label>
                                <input 
                                    type="range" min="1" max="10" step="0.5" 
                                    value={params.A} 
                                    onChange={(e) => updateParam('A', e.target.value)}
                                    className="accent-blue-500 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                                />
                            </div>
                         )}

                         {showFrequency && (
                            <div className="flex flex-col gap-1">
                                <label className="flex justify-between text-xs font-bold text-slate-400">
                                    Tần số f (Hz) <span className="text-white">{params.f}</span>
                                </label>
                                <input 
                                    type="range" min="0.1" max="5" step="0.1" 
                                    value={params.f} 
                                    onChange={(e) => updateParam('f', e.target.value)}
                                    className="accent-green-500 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                                />
                            </div>
                         )}
                         
                         {showPhase && (
                            <div className="flex flex-col gap-1">
                                <label className="flex justify-between text-xs font-bold text-slate-400">
                                    Pha ban đầu φ (rad) <span className="text-white">{params.phi.toFixed(2)}</span>
                                </label>
                                <input 
                                    type="range" min="-3.14" max="3.14" step="0.1" 
                                    value={params.phi} 
                                    onChange={(e) => updateParam('phi', e.target.value)}
                                    className="accent-yellow-500 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                                />
                            </div>
                         )}

                         {showSpringK && (
                            <div className="flex flex-col gap-1">
                                <label className="flex justify-between text-xs font-bold text-slate-400">
                                    Độ cứng k (N/m) <span className="text-white">{params.k}</span>
                                </label>
                                <input 
                                    type="range" min="10" max="200" step="5" 
                                    value={params.k} 
                                    onChange={(e) => updateParam('k', e.target.value)}
                                    className="accent-purple-500 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                                />
                            </div>
                         )}

                         {showMass && (
                            <div className="flex flex-col gap-1">
                                <label className="flex justify-between text-xs font-bold text-slate-400">
                                    Khối lượng m (kg) <span className="text-white">{params.m}</span>
                                </label>
                                <input 
                                    type="range" min="0.1" max="2" step="0.1" 
                                    value={params.m} 
                                    onChange={(e) => updateParam('m', e.target.value)}
                                    className="accent-orange-500 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                                />
                            </div>
                         )}
                         
                         {showLength && (
                            <div className="flex flex-col gap-1">
                                <label className="flex justify-between text-xs font-bold text-slate-400">
                                    Chiều dài dây l (m) <span className="text-white">{params.l}</span>
                                </label>
                                <input 
                                    type="range" min="0.2" max="2.0" step="0.1" 
                                    value={params.l} 
                                    onChange={(e) => updateParam('l', e.target.value)}
                                    className="accent-pink-500 h-1.5 bg-slate-700 rounded-lg appearance-none cursor-pointer"
                                />
                            </div>
                         )}
                    </div>
                </div>
            </div>
        </div>
    );
}
    </script>
</body>
</html>